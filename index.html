<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Tarefas - Isabela e Yasmin</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-pink-50 to-purple-50 min-h-screen">
    <div id="app" class="p-2 sm:p-6">
        <div class="max-w-6xl mx-auto">
            <!-- Carregando -->
            <div id="loading" class="text-center py-20">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600"></div>
                <p class="mt-4 text-gray-600">Conectando ao Home Assistant...</p>
            </div>

            <!-- Conteúdo principal -->
            <div id="content" style="display: none;">
                <!-- Cabeçalho -->
                <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6 mb-4 sm:mb-6">
                    <h1 class="text-2xl sm:text-3xl font-bold text-purple-800 text-center flex items-center justify-center gap-2">
                        💰 Controle de Tarefas - Isabela e Yasmin
                    </h1>
                    <p class="text-center text-sm text-green-600 mt-2">
                        🏠 Integrado com Home Assistant
                    </p>
                    <div id="erro" class="mt-3 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm text-center hidden"></div>
                </div>

                <!-- Cards de totais -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4 sm:mb-6">
                    <div class="bg-gradient-to-br from-pink-500 to-pink-600 rounded-lg shadow-lg p-4 sm:p-6 text-white">
                        <h3 class="text-lg sm:text-xl font-semibold mb-2">💖 Isabela</h3>
                        <p class="text-2xl sm:text-3xl font-bold" id="total-isabela-pendente">R$ 0,00</p>
                        <p class="text-xs sm:text-sm opacity-90">A receber</p>
                        <p class="text-xs sm:text-sm opacity-75 mt-2" id="total-yasmin">Total geral: R$ 0,00</p>
                    </div>
                </div>

                <!-- Formulário de registro -->
                <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6 mb-4 sm:mb-6">
                    <h2 class="text-lg sm:text-xl font-bold text-gray-800 mb-4">➕ Registrar Tarefas do Dia</h2>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Filha</label>
                            <select id="filha" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-base">
                                <option value="Isabela">Isabela</option>
                                <option value="Yasmin">Yasmin</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Data</label>
                            <input type="date" id="data" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-base">
                        </div>
                    </div>

                    <div class="space-y-3 mb-6">
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <span class="font-medium text-gray-700 text-sm sm:text-base">🛏️ Arrumar o quarto</span>
                            <select id="arrumarQuarto" class="p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-base">
                                <option value="nao">Não</option>
                                <option value="sim">Sim</option>
                            </select>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <span class="font-medium text-gray-700 text-sm sm:text-base">🧹 Retirar pó dos móveis</span>
                            <select id="retirarPo" class="p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-base">
                                <option value="nao">Não</option>
                                <option value="sim">Sim</option>
                            </select>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <span class="font-medium text-gray-700 text-sm sm:text-base">🍽️ Lavar louça</span>
                            <select id="lavarLouca" class="p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-base">
                                <option value="nao">Não</option>
                                <option value="sim">Sim</option>
                            </select>
                        </div>
                    </div>

                    <button id="btnGravar" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-3 sm:py-4 rounded-lg font-bold text-base sm:text-lg hover:from-purple-700 hover:to-pink-700 transition-all shadow-lg">
                        💾 GRAVAR
                    </button>
                </div>

                <!-- Botões de ação -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-4 sm:mb-6">
                    <button id="btnAtualizar" class="bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-all shadow-lg">
                        🔄 Atualizar
                    </button>
                    <button id="btnExportar" class="bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition-all shadow-lg">
                        📥 Exportar
                    </button>
                    <button id="btnLimpar" class="bg-red-600 text-white py-3 rounded-lg font-semibold hover:bg-red-700 transition-all shadow-lg">
                        ⚠️ Limpar Histórico
                    </button>
                </div>

                <!-- Histórico -->
                <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6">
                    <h2 class="text-lg sm:text-xl font-bold text-gray-800 mb-4">
                        📋 Histórico de Tarefas (<span id="totalRegistros">0</span>)
                    </h2>
                    <div id="historico" class="overflow-x-auto"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configurações
        const HA_URL = 'https://ha.homelab.ong.br';
        const HA_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJjOTQxNjgzYzEyYjM0NWE1YjgzMDdhNzlmYTUwNzI4MSIsImlhdCI6MTc2MTE4MjU5OCwiZXhwIjoyMDc2NTQyNTk4fQ.IE0bFGk26Y_QEeJ9Rh_nScBQ7neoKWW7ny800eCjFKg';
        const ARQUIVO_DADOS = 'tarefas_filhas.json';
        const VALOR_POR_TAREFA = 0.56;
        const SENHA_ADMIN = 'RLP72834609lpro!/';

        let registros = [];

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('data').valueAsDate = new Date();
            carregarDados();
            
            document.getElementById('btnGravar').addEventListener('click', gravarTarefa);
            document.getElementById('btnAtualizar').addEventListener('click', carregarDados);
            document.getElementById('btnExportar').addEventListener('click', exportarCSV);
            document.getElementById('btnLimpar').addEventListener('click', limparHistorico);
        });

        // Carregar dados do Home Assistant
        async function carregarDados() {
            try {
                mostrarErro('');
                const response = await fetch(`${HA_URL}/local/${ARQUIVO_DADOS}`, {
                    headers: { 'Authorization': `Bearer ${HA_TOKEN}` }
                });

                if (response.ok) {
                    const dados = await response.json();
                    registros = dados.registros || [];
                } else if (response.status === 404) {
                    registros = [];
                } else {
                    throw new Error('Erro ao carregar');
                }

                atualizarInterface();
            } catch (error) {
                mostrarErro('Erro ao conectar com Home Assistant');
                console.error(error);
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
            }
        }

        // Salvar dados no Home Assistant
        async function salvarDados() {
            try {
                const btnGravar = document.getElementById('btnGravar');
                btnGravar.disabled = true;
                btnGravar.textContent = '⏳ Salvando...';

                const dadosParaSalvar = {
                    registros: registros,
                    ultimaAtualizacao: new Date().toISOString()
                };

                const response = await fetch(`${HA_URL}/api/services/file_editor/write`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${HA_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        path: `/config/www/${ARQUIVO_DADOS}`,
                        content: JSON.stringify(dadosParaSalvar, null, 2)
                    })
                });

                if (!response.ok) throw new Error('Erro ao salvar');
                
                atualizarInterface();
                setTimeout(() => {
                    btnGravar.disabled = false;
                    btnGravar.textContent = '💾 GRAVAR';
                }, 500);
            } catch (error) {
                mostrarErro('Erro ao salvar no Home Assistant');
                console.error(error);
            }
        }

        // Gravar nova tarefa
        function gravarTarefa() {
            const filha = document.getElementById('filha').value;
            const data = document.getElementById('data').value;
            const arrumarQuarto = document.getElementById('arrumarQuarto').value === 'sim';
            const retirarPo = document.getElementById('retirarPo').value === 'sim';
            const lavarLouca = document.getElementById('lavarLouca').value === 'sim';

            const tarefasRealizadas = [arrumarQuarto, retirarPo, lavarLouca].filter(Boolean).length;
            const valor = tarefasRealizadas * VALOR_POR_TAREFA;

            const novoRegistro = {
                id: Date.now(),
                filha,
                data,
                arrumarQuarto,
                retirarPo,
                lavarLouca,
                valor,
                pago: false
            };

            registros.push(novoRegistro);
            salvarDados();

            // Resetar formulário
            document.getElementById('arrumarQuarto').value = 'nao';
            document.getElementById('retirarPo').value = 'nao';
            document.getElementById('lavarLouca').value = 'nao';
        }

        // Atualizar interface
        function atualizarInterface() {
            // Totais Isabela
            const totalIsabelaPendente = registros
                .filter(r => r.filha === 'Isabela' && !r.pago)
                .reduce((acc, r) => acc + r.valor, 0);
            const totalIsabela = registros
                .filter(r => r.filha === 'Isabela')
                .reduce((acc, r) => acc + r.valor, 0);

            document.getElementById('total-isabela-pendente').textContent = `R$ ${totalIsabelaPendente.toFixed(2)}`;
            document.getElementById('total-isabela').textContent = `Total geral: R$ ${totalIsabela.toFixed(2)}`;

            // Totais Yasmin
            const totalYasminPendente = registros
                .filter(r => r.filha === 'Yasmin' && !r.pago)
                .reduce((acc, r) => acc + r.valor, 0);
            const totalYasmin = registros
                .filter(r => r.filha === 'Yasmin')
                .reduce((acc, r) => acc + r.valor, 0);

            document.getElementById('total-yasmin-pendente').textContent = `R$ ${totalYasminPendente.toFixed(2)}`;
            document.getElementById('total-yasmin').textContent = `Total geral: R$ ${totalYasmin.toFixed(2)}`;

            // Histórico
            document.getElementById('totalRegistros').textContent = registros.length;
            renderizarHistorico();
        }

        // Renderizar histórico
        function renderizarHistorico() {
            const historico = document.getElementById('historico');
            
            if (registros.length === 0) {
                historico.innerHTML = '<p class="text-center text-gray-500 py-8">Nenhum registro ainda. Comece registrando as tarefas!</p>';
                return;
            }

            let html = '<table class="w-full text-sm"><thead><tr class="border-b-2 border-gray-200">';
            html += '<th class="text-left p-2 sm:p-3">Data</th>';
            html += '<th class="text-left p-2 sm:p-3">Filha</th>';
            html += '<th class="text-center p-2 sm:p-3 hidden sm:table-cell">🛏️</th>';
            html += '<th class="text-center p-2 sm:p-3 hidden sm:table-cell">🧹</th>';
            html += '<th class="text-center p-2 sm:p-3 hidden sm:table-cell">🍽️</th>';
            html += '<th class="text-right p-2 sm:p-3">Valor</th>';
            html += '<th class="text-center p-2 sm:p-3">Status</th>';
            html += '<th class="text-center p-2 sm:p-3">Ações</th>';
            html += '</tr></thead><tbody>';

            registros.slice().reverse().forEach(r => {
                const dataFormatada = new Date(r.data + 'T00:00:00').toLocaleDateString('pt-BR');
                const corFilha = r.filha === 'Isabela' ? 'text-pink-600' : 'text-purple-600';
                const statusCor = r.pago ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700';
                const statusTexto = r.pago ? 'Pago' : 'Pendente';

                html += `<tr class="border-b border-gray-100 hover:bg-gray-50">`;
                html += `<td class="p-2 sm:p-3 text-xs sm:text-sm">${dataFormatada}</td>`;
                html += `<td class="p-2 sm:p-3"><span class="font-semibold ${corFilha}">${r.filha}</span></td>`;
                html += `<td class="text-center p-2 sm:p-3 hidden sm:table-cell">${r.arrumarQuarto ? '✅' : '❌'}</td>`;
                html += `<td class="text-center p-2 sm:p-3 hidden sm:table-cell">${r.retirarPo ? '✅' : '❌'}</td>`;
                html += `<td class="text-center p-2 sm:p-3 hidden sm:table-cell">${r.lavarLouca ? '✅' : '❌'}</td>`;
                html += `<td class="text-right p-2 sm:p-3 font-semibold text-green-600">R$ ${r.valor.toFixed(2)}</td>`;
                html += `<td class="text-center p-2 sm:p-3">`;
                html += `<button onclick="togglePago(${r.id})" class="px-2 sm:px-3 py-1 rounded-full text-xs font-semibold ${statusCor}">${statusTexto}</button>`;
                html += `</td>`;
                html += `<td class="text-center p-2 sm:p-3">`;
                html += `<button onclick="excluirRegistro(${r.id})" class="text-red-600 hover:text-red-800 p-2">🗑️</button>`;
                html += `</td>`;
                html += `</tr>`;
            });

            html += '</tbody></table>';
            historico.innerHTML = html;
        }

        // Toggle status pago
        function togglePago(id) {
            registros = registros.map(r => 
                r.id === id ? { ...r, pago: !r.pago } : r
            );
            salvarDados();
        }

        // Excluir registro
        function excluirRegistro(id) {
            if (confirm('Deseja realmente excluir este registro?')) {
                registros = registros.filter(r => r.id !== id);
                salvarDados();
            }
        }

        // Limpar histórico
        function limparHistorico() {
            const senha = prompt('⚠️ ATENÇÃO: Esta ação irá apagar TODO o histórico!\n\nDigite a senha de administrador:');
            
            if (senha === null) return;
            
            if (senha === SENHA_ADMIN) {
                if (confirm('⚠️ ÚLTIMA CONFIRMAÇÃO:\n\nTem certeza que deseja apagar TODOS os registros?\n\nEsta ação não pode ser desfeita!')) {
                    registros = [];
                    salvarDados();
                    alert('✅ Histórico limpo com sucesso!');
                }
            } else {
                alert('❌ Senha incorreta! O histórico não foi apagado.');
            }
        }

        // Exportar CSV
        function exportarCSV() {
            const csv = [
                ['Data', 'Filha', 'Arrumar Quarto', 'Retirar Pó', 'Lavar Louça', 'Valor (R$)', 'Status'],
                ...registros.map(r => [
                    r.data,
                    r.filha,
                    r.arrumarQuarto ? 'Sim' : 'Não',
                    r.retirarPo ? 'Sim' : 'Não',
                    r.lavarLouca ? 'Sim' : 'Não',
                    r.valor.toFixed(2),
                    r.pago ? 'Pago' : 'Pendente'
                ])
            ].map(row => row.join(',')).join('\n');

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `tarefas_filhas_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // Mostrar erro
        function mostrarErro(msg) {
            const erro = document.getElementById('erro');
            if (msg) {
                erro.textContent = '⚠️ ' + msg;
                erro.classList.remove('hidden');
            } else {
                erro.classList.add('hidden');
            }
        }
    </script>
</body>
</html>total-isabela">Total geral: R$ 0,00</p>
                    </div>
                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg shadow-lg p-4 sm:p-6 text-white">
                        <h3 class="text-lg sm:text-xl font-semibold mb-2">💜 Yasmin</h3>
                        <p class="text-2xl sm:text-3xl font-bold" id="total-yasmin-pendente">R$ 0,00</p>
                        <p class="text-xs sm:text-sm opacity-90">A receber</p>
                        <p class="text-xs sm:text-sm opacity-75 mt-2" id="
